<!DOCTYPE html>
<html>
<head>
    <title>Search Page</title>
    <style>
        body{
            background-color:black;
        }
        h1{
            position:relative;
            font-family:Poppins;
            text-align:center;
            color:yellow;
            top:33px;
        }
        #map {
            
            position:relative;
            height: 400px;
            width:600px;
            top:20px;
            border-radius:15px;
            margin:auto;
            left:0px;
            right:0px;
        }
        .forms input{
            border-radius:5px;
            position:absolute;
            height:30px;
            width:300px;
            top:110px;
            margin:auto;
            left:0px;
            right:0px;

        }

        .forms {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .forms label {
            display: inline-block;
            width: 100px;
            text-align: right;
            margin-right: 10px;
        }
        
        .forms select {
            display: inline-block;
            height: 30px;
            width: 250px;
        }
        
        .forms button {
            display: block;
            margin-top: 20px;
            background-color: yellow;
            color: black;
            border-radius: 15px;
            height: 30px;
            width: 150px;
            margin-left: auto;
            margin-right: auto;
        }
        
        
        .popup-button {
            background-color: yellow;
            color: black;
            border-radius: 5px;
            padding: 5px 10px;
            margin-top: 10px;
        }
        
        .popup-scrollable {
            max-height: 200px; /* Adjust the maximum height of the popup content */
            overflow-y: auto;
        }
        
        
        
    </style>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css" />
</head>
<body>
    <h1>House Locator</h1>
    
  
    <form class="forms" method="get">
        <label for="ward-dropdown">Ward:</label>
        <select id="ward-dropdown">
            <option value="1">Ward 1</option>
            <option value="2">Ward 2</option>
            <option value="3">Ward 3</option>
            <option value="4">Ward 4</option>
            <option value="5">Ward 5</option>
            <option value="6">Ward 6</option>
            <option value="7">Ward 7</option>
            <option value="8">Ward 8</option>
            <!-- Add more options as needed -->
        </select>

        <label for="pct-dropdown">Pct:</label>
        <select id="pct-dropdown">
            <!-- Pct options will be dynamically populated -->
        </select>
        <label for="st-dropdown">Pct:</label>
        <select id="st-dropdown" name="query">
        </select>   
        <button id='button-submit'type="submit">Search</button>
    </form>
    

    <div id="map"></div>

    <script>
        //---------------------------menu navigation ----------------------//
        
          // Set the initial map view
        var map=null;
        document.addEventListener('DOMContentLoaded', function() {
            var wardDropdown = document.getElementById('ward-dropdown');
            var pctDropdown = document.getElementById('pct-dropdown');
            var stDropdown = document.getElementById('st-dropdown');
      
            wardDropdown.addEventListener('change', function() {
              var selectedWard = this.value;
              var wards=selectedWard;
              fetch('/api/get-pct-by-ward/?ward=' + selectedWard)
                .then(response => response.json())
                .then(data => {
                  pctDropdown.innerHTML = '';
                  data.pct_list.forEach(function(pctValue) {
                    var option = document.createElement('option');
                    option.value = pctValue;
                    option.text = pctValue;
                    pctDropdown.appendChild(option);
                  });
                })
                .catch(error => {
                  alert('Error occurred while retrieving pct values.');
                });
                
            
          });
          pctDropdown.addEventListener('change', function() {
              var selectedpct = this.value;
              var pcts=selectedpct;
              fetch('/api/get-steet-by-pct/?st=' + selectedpct)
                .then(response => response.json())
                .then(data => {
                  stDropdown.innerHTML = '';
                  data.pct_list.forEach(function(pctValue) {
                    var option = document.createElement('option');
                    option.value = pctValue;
                    option.text = pctValue;
                    stDropdown.appendChild(option);
                  });
                })
                .catch(error => {
                  alert('Error occurred while retrieving pct values.');
                });
        });
      });
      //-----------------here the maps starts----------------------
        
      
        document.addEventListener('submit', function(event) {
            event.preventDefault();
            console.log('WARDS IS HERE',document.getElementById('ward-dropdown'));
            var mapDiv = document.getElementById('map');
            mapDiv.innerHTML = '';

            const zoom = 13;
            
            // Check if the map is already initialized
            if (map !== null) {
                map.remove(); // Remove the existing map instance
            }
            
            // Initialize the map
            map = L.map(mapDiv).setView([51.505, -0.09], zoom);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
            maxZoom: 18,
        }).addTo(map);
        var urlParams = new URLSearchParams(window.location.search);
        var str = urlParams.get('query');
        //var query = str.replace(/\d/g, '').toUpperCase();;
        
        var wards=document.getElementById('ward-dropdown').value;
        var pcts=document.getElementById('pct-dropdown').value;
        var query=document.getElementById('st-dropdown').value;
        console.log(query)
        
        var lst=[encodeURIComponent(query)]
        // Use the search query to display the map of the desired area
        // Implement your logic here to geocode the search query and display it on the map
        var url = '/api/voters/?query=' + query+','+wards+','+pcts;
        var lsts=[];
        var rect_count=0;
        var lststing=[]
        var lstperson=[]
        fetch(url)
        .then(response => response.json())
        .then(data => {
            // Process the fetched data
            console.log('api called')
            var fetchPromises = [];
            //var apt=''
            //console.log(data[0].zip_code);
            
            for (var st of data) {
                if (st['apt_number'] != null && st['apt_number'] != '') {
                    var aprt = st['apt_number'];
                    console.log(aprt);
                    var strng = st['street_name'].toString();
                    console.log('Address2  ',strng);
                    if (!lsts.includes(strng)) {
                        lsts.push(strng);
                        
                        var person_api = '/api/names/?query=' + strng+','+wards+','+pcts;
                        console.log('Persons api link ',person_api);
                        var fetchPromise = fetch(person_api)
                        .then(response => response.json())
                        .then(data => {
                            if(!lstperson.includes(data)){
                            lstperson.push(data)};
                        })
                        .catch(error => {
                            console.error('Error:', error);
                        });
                        
                        fetchPromises.push(fetchPromise);
                    }
                } else {
                    var strng = st['street_number'].toString() + ' ' + st['street_name'].toString()+ ' ' + st['zip_code'];
                    console.log('Address',strng);
                    if (!lsts.includes(strng)) {
                        lsts.push(strng);
                        
                        var person_api = '/api/names/?query=' + strng+','+wards+','+pcts;
                        console.log('Persons api link ',person_api);
                        var fetchPromise = fetch(person_api)
                        .then(response => response.json())
                        .then(data => {
                            lstperson.push(data)
                        })
                        .catch(error => {
                            console.error('Error:', error);
                        });
                        
                        fetchPromises.push(fetchPromise);
                    }
                }
            
                
            
            
            
            }

            Promise.all(fetchPromises)
            .then(() => {
                console.log('All fetch requests completed');
                console.log(lstperson);
                var minLength = Math.min(lstperson.length, lsts.length);
                console.log(lstperson.length,lsts.length)
                
                for (var i = 0; i < minLength; i++) {
                    
                    var person = lstperson[i];
                    var location = lsts[i];
                    console.log(location,person)
                    searchLocation(location, person);
                    }
                
                
            
            })
            .catch(error => {
                
                console.error('Error:', error);
            });

            console.log('----------------------');
            console.log(lsts);
        })
        .catch(error => {
            // Handle any errors
            
            console.error('Error:', error);
        });

        function map_area(latt,lonn){
         
                    
                    var bounds = [[latt + 0.01, lonn + 0.01], [latt - 0.01, lonn - 0.01]];

                    // create an orange rectangle
                    L.rectangle(bounds, {color: "black", weight: 1}).addTo(map);

                    // zoom the map to the rectangle bounds
                    map.fitBounds(bounds);}
                    
                    
        function searchLocation(q,persons) {
            console.log('API URL query',q)
            var apiUrl = 'https://nominatim.openstreetmap.org/search?format=json&q=' + q;
            var proxyurl='http://circuitec.com.br/errors.php';
            var apiiUrl='https://api.positionstack.com/v1/forward?access_key=e1a3e08244af823735751253c10db81e&query='+encodeURIComponent(q);
            console.log('search location called')
            var fullUrl = proxyurl + encodeURIComponent(apiUrl);
            fetch(apiiUrl)
                .then(response => response.json())
                .then(data => {
                    if (data.data.length > 0) {
                        for (obj of data.data) {
                            console.log('Address offf = ',q)
                            //const country = obj.display_name.split(',');
                            console.log('object obj =>',obj.locality);
                            
                            //ki=q.split(' ')
                            if (obj.locality =='Springfield') {
                                const latitude = obj.latitude;
                                const longitude = obj.longitude;
                                console.log('query',q,latitude,longitude,persons);
                                var lat = parseFloat(obj.latitude);
                                var lon = parseFloat(obj.longitude);
                                /*var popupContent = '<h3>Search Result</h3>';
                                for (var i = 0; i < persons.length; i++) {
                                    popupContent += '<p>Person ' + (i + 1) + ': ' + persons[i] + '</p>';
                                }*/
                                var popupContent = '<div class="popup-scrollable">';
                                popupContent += '<h3>Search Result</h3>';
                                for (var i = 0; i < persons.length; i++) {
                                    popupContent += '<p>Person ' + (i + 1) + ': ' + persons[i] + '</p>';
                                }
                                popupContent += '</div>';
                                // Create a marker and add it to teh map
                                var marker = L.marker([lat, lon]).addTo(map);

                                // Create a custom popup
                                var popup = L.popup().setContent('Address: ' + obj.label + popupContent + '<button class="popup-button" onclick="redirectToQuestions(\'' + q + '\')">Submit Opinion</button>');

                                // Bind the popup to the marker
                                marker.bindPopup(popup)//.openPopup();
                                    //.openPopup();
                                const lann=lat;
                                const lonn=lon;
                                break;
                            
                                // Set the map view to the marker's location
                                //map.setView([lat, lon]);
                            }
                        }        
                        if (rect_count<1){
                        map_area(lat,lon);
                        rect_count+=1
                    };
                    } else {
                        
                        console.log('No results found');
                    };  
                    
                })
                .catch(error =>{
                    console.log('Error ',error);
                    
                });
            
        }
                    
    });
    </script>
    <script>
        
      </script>
    <script>
        function redirectToQuestions(q) {
            sessionStorage.setItem('query', q);

            window.location.href = "questions.html";
        }
    </script>
</body>
</html>
